<h3>Commande</h3>

<div class="mb-3">
    <button class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#createCommande">
        <i class="fas fa-plus"></i>
        Créer une commande
    </button>
    <button class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#addCommande">
        <i class="fas fa-plus"></i>
        Ajouter une commande
    </button>
    <button class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#addUser">
        <i class="fas fa-plus"></i>
        Assigner une commande
    </button>


    <div class=" mt-5 px-2">
        <div class="card">
            <div class="card-body">
                <div class="mb-2 d-flex justify-content-between align-items-center">
                </div>
                <div class="table-responsive">
                    <table class="table table-striped-columns table-bordered align-middle ">

                        <thead>
                            <tr class="bg-light">
                                <th scope="col" width="5%"><input class="form-check-input" type="checkbox"></th>
                                <th scope="col" width="10%">Canal de Vente</th>
                                <th scope="col" width="20%">Agent</th>
                                <th scope="col" width="20%">Numero de suivi</th>
                                <th scope="col" width="20%">Article(s) commandé(s)</th>
                                <th scope="col" width="20%">Prix total</th>
                                <th scope="col" width="20%">Telephone client</th>
                                <th scope="col" width="20%">Adresse de livraison</th>
                                <th scope="col" width="20%">Ville client</th>
                                <th scope="col" width="20%">Status commande</th>
                                <th scope="col" width="20%">Livraison</th>
                                <th scope="col" width="20%">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {{#each commandes}}
                            <tr>
                                <th scope="row"><input class="form-check-input" type="checkbox"></th>
                                <td>Valdez</td>
                                <td>Call center</td>
                                <td>0122</td>
                                <td>VVVV</td>
                                <td>5000F</td>
                                <td>698233443</td>
                                <td>Makepe</td>
                                <td>Douala</td>
                                <td><span class="badge bg-danger">En cours</span></td>
                                <td><span class="badge bg-danger">Reporte</span></td>
                                <td>
                                    <button class="btn btn-sm btn-warning" data-bs-toggle="modal"><i class="fas fa-edit"></i></button>
                            
                                    <button class="btn btn-sm btn-danger" data-bs-toggle="modal"><i class="fa fa-trash"
                                            aria-hidden="true"></i></button>
                                </td>
                            
                            </tr>
                            {{/each}}
                           
                        </tbody>
                    </table>

                </div>

            </div>
        </div>

    </div>
</div>


<!-- Modal Body -->
<!-- if you want to close by clicking outside the modal, delete the last endpoint:data-bs-backdrop and data-bs-keyboard -->
<div class="modal fade" id="createCommande" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false"
    role="dialog" aria-labelledby="modalTitleId" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitleId">Créer une commande</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body stepper">
                <div class="row">
                    <form method="post" action="/commandes/add">
                    <div class="col">
                        <h3>Information de la commande</h3>
                        <div class="commande_info">
                            <div class="mb-3">
                                <label for="name" class="form-label">Nom du client</label>
                                <input type="text" class="form-control" name="name" id="name" aria-describedby="helpId"
                                    placeholder="">
                                <small id="helpId" class="form-text text-muted"></small>
                            </div>
                            <div class="mb-3">
                                <label for="numero_client" class="form-label">Numero du client</label>
                                <input type="text" class="form-control" name="numero_client" id="numero_client"
                                    aria-describedby="helpId" placeholder="">
                                <small id="helpId" class="form-text text-muted"></small>
                            </div>
                            <div class="mb-3">
                                <label for="address_livraison" class="form-label">Adresse de livraison</label>
                                <input type="text" class="form-control" name="address_livraison" id="address_livraison"
                                    aria-describedby="helpId" placeholder="">
                                <small id="helpId" class="form-text text-muted"></small>
                            </div>
                            <div class="mb-3">
                                <label for="stock" class="form-label">Magasin de: </label>
                                <select class="form-select form-select-lg" name="stock_id" id="stock">
                                    <option selected>Selectionner le magasin</option>
                                    {{#each users}}
                                        <option value="{{id}}">{{fullname}}</option>
                                    {{/each}}
                                </select>
                            </div>
                           <!-- <div class="mb-3">
                                <label for="numero_client" class="form-label">Numero du client</label>
                                <input type="text" class="form-control" name="numero_client" id="numero_client"
                                    aria-describedby="helpId" placeholder="">
                                <small id="helpId" class="form-text text-muted"></small>
                            </div>-->

                        </div>
                        <button class="btn btn-primary float-end next-button" type="button">Commencer</button>
                    </div>
                    <div class="col" style="display: none;">
                        <h3>Choisir les articles</h3>

                        <div multi-input>
                            <div class="input-group mb-3" >
                                {{!-- <label for="quartier" class="form-label">Quartier Recuperation</label> --}}
                                <select class="form-select" name="article_id" id="article" aria-label="Default select example">
                                    <option selected value="">Selectionner l'article</option>
                                    <!--{{#each articles}}
                                     <option value="{{id}}">{{"Article.name"}}</option>
                                    {{/each}}-->
                                </select>
                                <input type="number" class="form-control" placeholder="quantite" name="quantite"
                                    min="1">
                                <button class="btn btn-primary" type="button"><i class="fas fa-plus"></i></button>
                            </div>
                        </div>

                        <button class="btn btn-secondary prev-button">Retour</button>
                        <button type="button" class="btn btn-primary float-end next-button" onclick="onSubmit()">Commander</button>
                    </div>
                    </form>
                </div>
            </div>
            {{!-- <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary">Save</button>
            </div> --}}
        </div>
    </div>
</div>
<!-- Modal Body -->
<!-- if you want to close by clicking outside the modal, delete the last endpoint:data-bs-backdrop and data-bs-keyboard -->
<div class="modal fade" id="addUser" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false" role="dialog"
    aria-labelledby="addRoleTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addRoleTitle">Assigner une commande à un utilisateur</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form action="/admin/User/add" method="post">
                    <div class="mb-3">
                        <label for="name" class="form-label">Nom</label>
                        <input type="text" class="form-control" name="name" id="name" aria-describedby="helpId"
                            placeholder="">
                        <small id="helpId" class="form-text text-muted"></small>
                    </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                <button type="submit" class="btn btn-primary">Enregistrer</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    function onSubmit(){
        let prepData = {}
        const multInput = []
        let inputs = {}
        let articles = []
        const name = document.querySelector("#name");
        const commande_info = [...document.querySelectorAll(".commande_info input"),...document.querySelectorAll(".commande_info select")];
        const multiInputs = document.querySelector("[multi-input]").children;
       multiInputs.forEach((multiInput)=>{
         [...multiInput.querySelectorAll("input"), ...multiInput.querySelectorAll("select")].forEach(mInput => {
               prepData = { ...prepData, [mInput.name]: mInput.value }
           })
           multInput.push(prepData);
         })
         articles=multInput
         commande_info.forEach((cmInfo)=>{
            inputs = {...inputs,[cmInfo.name]:cmInfo.value}
         })
         const data = {
            ...inputs,
            articles:articles
         }
        fetch("/commandes/add",{
            method:"POST",
            headers:{
                "Content-Type":"application/json"
            },
            body:JSON.stringify(data),
            redirect:"follow"
        }).then((res)=>res.status===201&&window.location.reload())
        
    }
    document.addEventListener("DOMContentLoaded", function () {
        var currentStep = 0;
        var steps = document.querySelectorAll(".stepper .row .col");

        // Hide all steps except the first one
        for (var i = 1; i < steps.length; i++) {
            steps[i].style.display = "none";
        }

        var nextButtons = document.querySelectorAll(".next-button");
        var prevButtons = document.querySelectorAll(".prev-button");

        // Add event listeners to next buttons
        nextButtons.forEach(function (button) {
            button.addEventListener("click", function () {
                if (currentStep < steps.length - 1) {
                    steps[currentStep].style.display = "none";
                    currentStep++;
                    steps[currentStep].style.display = "block";
                }
            });
        });

        // Add event listeners to previous buttons
        prevButtons.forEach(function (button) {
            button.addEventListener("click", function () {
                if (currentStep > 0) {
                    steps[currentStep].style.display = "none";
                    currentStep--;
                    steps[currentStep].style.display = "block";
                }
            });
        });
    });

    document.querySelector("#stock").addEventListener("change",(e)=>{
        const articleSelects = document.querySelectorAll("#article")
        const value = e.target.value
        fetch(`/admin/stocks/${value}`,{
            method:"POST",
        }).then(async(res)=>{
            if(res.status===200){
                const data = await res.json()
                data.map((articles)=>{
                    articleSelects.forEach((articleSelect)=>{
                        const option= document.createElement("option")
                        option.value = articles.article_id
                        option.innerText  = articles["Article.name"]
                        articleSelect.append(option)
                    })
                })
            }
        })
    })

</script>